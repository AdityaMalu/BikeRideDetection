name: Android CI/CD Pipeline

on:
  push:
    branches: [ main, v2, develop ]
  pull_request:
    branches: [ main, v2 ]

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ============================================================================
  # CODE QUALITY CHECKS
  # ============================================================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run ktlint
        run: ./gradlew ktlintCheck --continue
        continue-on-error: true

      - name: Run detekt
        run: ./gradlew detekt --continue
        continue-on-error: true

      - name: Upload ktlint report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ktlint-report
          path: app/build/reports/ktlint/
          retention-days: 7

      - name: Upload detekt report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: detekt-report
          path: app/build/reports/detekt/
          retention-days: 7

  # ============================================================================
  # UNIT TESTS
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create dummy google-services.json
        run: |
          cat > app/google-services.json << 'EOF'
          {
            "project_info": {"project_number": "000000000000", "project_id": "dummy-project", "storage_bucket": "dummy-project.appspot.com"},
            "client": [{"client_info": {"mobilesdk_app_id": "1:000000000000:android:0000000000000000", "android_client_info": {"package_name": "com.example.bikeridedetection"}}, "oauth_client": [], "api_key": [{"current_key": "dummy_key"}], "services": {"appinvite_service": {"other_platform_oauth_client": []}}}, {"client_info": {"mobilesdk_app_id": "1:000000000000:android:0000000000000001", "android_client_info": {"package_name": "com.example.bikeridedetection.debug"}}, "oauth_client": [], "api_key": [{"current_key": "dummy_key"}], "services": {"appinvite_service": {"other_platform_oauth_client": []}}}],
            "configuration_version": "1"
          }
          EOF

      - name: Run unit tests
        run: ./gradlew testDebugUnitTest

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: app/build/reports/tests/
          retention-days: 7

      - name: Upload test coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-coverage
          path: app/build/reports/coverage/
          retention-days: 7

  # ============================================================================
  # BUILD DEBUG APK
  # ============================================================================
  build-debug:
    name: Build Debug APK
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create dummy google-services.json
        run: |
          cat > app/google-services.json << 'EOF'
          {
            "project_info": {"project_number": "000000000000", "project_id": "dummy-project", "storage_bucket": "dummy-project.appspot.com"},
            "client": [{"client_info": {"mobilesdk_app_id": "1:000000000000:android:0000000000000000", "android_client_info": {"package_name": "com.example.bikeridedetection"}}, "oauth_client": [], "api_key": [{"current_key": "dummy_key"}], "services": {"appinvite_service": {"other_platform_oauth_client": []}}}, {"client_info": {"mobilesdk_app_id": "1:000000000000:android:0000000000000001", "android_client_info": {"package_name": "com.example.bikeridedetection.debug"}}, "oauth_client": [], "api_key": [{"current_key": "dummy_key"}], "services": {"appinvite_service": {"other_platform_oauth_client": []}}}],
            "configuration_version": "1"
          }
          EOF

      - name: Build debug APK
        run: ./gradlew assembleDebug

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 14


  # ============================================================================
  # BUILD RELEASE APK
  # ============================================================================
  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/v2')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            echo "Attempting to decode google-services.json..."
            echo "Secret length: ${#GOOGLE_SERVICES_JSON} characters"
            echo "First 20 chars: $(echo "$GOOGLE_SERVICES_JSON" | head -c 20)..."

            DECODED=false

            # Method 1: Check if it's already raw JSON
            if echo "$GOOGLE_SERVICES_JSON" | grep -q '^[[:space:]]*{'; then
              echo "Method 1: Detected raw JSON format"
              echo "$GOOGLE_SERVICES_JSON" > app/google-services.json
              DECODED=true
            fi

            # Method 2: Try base64 decode with -d flag (Linux)
            if [ "$DECODED" = false ]; then
              echo "Method 2: Trying base64 -d..."
              if echo "$GOOGLE_SERVICES_JSON" | base64 -d > app/google-services.json 2>/dev/null; then
                if [ -s app/google-services.json ] && head -c 1 app/google-services.json | grep -q '{'; then
                  echo "Method 2: Success"
                  DECODED=true
                fi
              fi
            fi

            # Method 3: Try with whitespace stripped
            if [ "$DECODED" = false ]; then
              echo "Method 3: Trying base64 -d with whitespace stripped..."
              if echo "$GOOGLE_SERVICES_JSON" | tr -d '[:space:]' | base64 -d > app/google-services.json 2>/dev/null; then
                if [ -s app/google-services.json ] && head -c 1 app/google-services.json | grep -q '{'; then
                  echo "Method 3: Success"
                  DECODED=true
                fi
              fi
            fi

            # Method 4: Try Python base64 decode (more lenient)
            if [ "$DECODED" = false ]; then
              echo "Method 4: Trying Python base64 decode..."
              if python3 -c "
          import base64
          import sys
          data = '''$GOOGLE_SERVICES_JSON'''.strip()
          # Add padding if needed
          padding = 4 - len(data) % 4
          if padding != 4:
              data += '=' * padding
          decoded = base64.b64decode(data)
          sys.stdout.buffer.write(decoded)
          " > app/google-services.json 2>/dev/null; then
                if [ -s app/google-services.json ] && head -c 1 app/google-services.json | grep -q '{'; then
                  echo "Method 4: Success"
                  DECODED=true
                fi
              fi
            fi

            # Validate the result
            if [ "$DECODED" = true ]; then
              if python3 -c "import json; json.load(open('app/google-services.json'))" 2>/dev/null; then
                echo "✓ google-services.json is valid JSON"
              else
                echo "✗ Decoded but not valid JSON, showing first 200 chars:"
                head -c 200 app/google-services.json
                DECODED=false
              fi
            fi

            if [ "$DECODED" = false ]; then
              echo "✗ All decode methods failed. Using dummy google-services.json"
              echo "Please re-encode your google-services.json with: base64 -w 0 app/google-services.json"
              cat > app/google-services.json << 'EOFINNER'
          {"project_info":{"project_number":"000000000000","project_id":"dummy-project","storage_bucket":"dummy-project.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000","android_client_info":{"package_name":"com.example.bikeridedetection"}},"oauth_client":[],"api_key":[{"current_key":"dummy_key"}],"services":{"appinvite_service":{"other_platform_oauth_client":[]}}}],"configuration_version":"1"}
          EOFINNER
            fi
          else
            echo "Warning: GOOGLE_SERVICES_JSON secret not set, using dummy"
            cat > app/google-services.json << 'EOF'
          {"project_info":{"project_number":"000000000000","project_id":"dummy-project","storage_bucket":"dummy-project.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000","android_client_info":{"package_name":"com.example.bikeridedetection"}},"oauth_client":[],"api_key":[{"current_key":"dummy_key"}],"services":{"appinvite_service":{"other_platform_oauth_client":[]}}}],"configuration_version":"1"}
          EOF
          fi

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "Decoding keystore..."
            echo "Secret length: ${#KEYSTORE_BASE64} characters"
            mkdir -p keystores

            DECODED=false

            # Method 1: Try standard base64 decode
            if echo "$KEYSTORE_BASE64" | base64 -d > keystores/bikeride-release.jks 2>/dev/null; then
              if [ -s keystores/bikeride-release.jks ]; then
                echo "Method 1: Success"
                DECODED=true
              fi
            fi

            # Method 2: Try with whitespace stripped
            if [ "$DECODED" = false ]; then
              echo "Method 2: Trying with whitespace stripped..."
              if echo "$KEYSTORE_BASE64" | tr -d '[:space:]' | base64 -d > keystores/bikeride-release.jks 2>/dev/null; then
                if [ -s keystores/bikeride-release.jks ]; then
                  echo "Method 2: Success"
                  DECODED=true
                fi
              fi
            fi

            # Method 3: Try Python base64 decode
            if [ "$DECODED" = false ]; then
              echo "Method 3: Trying Python base64 decode..."
              if python3 -c "
          import base64
          import sys
          data = '''$KEYSTORE_BASE64'''.strip().replace(' ', '').replace('\n', '')
          padding = 4 - len(data) % 4
          if padding != 4:
              data += '=' * padding
          decoded = base64.b64decode(data)
          sys.stdout.buffer.write(decoded)
          " > keystores/bikeride-release.jks 2>/dev/null; then
                if [ -s keystores/bikeride-release.jks ]; then
                  echo "Method 3: Success"
                  DECODED=true
                fi
              fi
            fi

            # Verify keystore was created
            if [ "$DECODED" = true ] && [ -f "keystores/bikeride-release.jks" ] && [ -s "keystores/bikeride-release.jks" ]; then
              FILESIZE=$(stat -c%s keystores/bikeride-release.jks 2>/dev/null || stat -f%z keystores/bikeride-release.jks)
              echo "✓ Keystore decoded successfully ($FILESIZE bytes)"

              cat > keystore.properties << EOF
          storeFile=keystores/bikeride-release.jks
          storePassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          keyPassword=$KEY_PASSWORD
          EOF
              echo "✓ keystore.properties created"
            else
              echo "✗ Error: Failed to decode keystore"
              echo "Please re-encode with: base64 -w 0 keystores/bikeride-release.jks"
              exit 1
            fi
          else
            echo "Warning: KEYSTORE_BASE64 secret not set, release APK will be unsigned"
          fi

      - name: Build release APK
        run: ./gradlew assembleRelease

      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/app-release*.apk
          retention-days: 30

  # ============================================================================
  # INSTRUMENTATION TESTS (on push to main only)
  # Note: Disabled by default as emulator tests are flaky on GitHub Actions
  # To enable, change 'if: false' to the condition below
  # ============================================================================
  instrumentation-tests:
    name: Instrumentation Tests
    runs-on: ubuntu-latest
    needs: build-debug
    # Disabled: Emulator tests are flaky on GitHub Actions
    # Enable with: if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    if: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create dummy google-services.json
        run: |
          cat > app/google-services.json << 'EOF'
          {
            "project_info": {"project_number": "000000000000", "project_id": "dummy-project", "storage_bucket": "dummy-project.appspot.com"},
            "client": [{"client_info": {"mobilesdk_app_id": "1:000000000000:android:0000000000000000", "android_client_info": {"package_name": "com.example.bikeridedetection"}}, "oauth_client": [], "api_key": [{"current_key": "dummy_key"}], "services": {"appinvite_service": {"other_platform_oauth_client": []}}}, {"client_info": {"mobilesdk_app_id": "1:000000000000:android:0000000000000001", "android_client_info": {"package_name": "com.example.bikeridedetection.debug"}}, "oauth_client": [], "api_key": [{"current_key": "dummy_key"}], "services": {"appinvite_service": {"other_platform_oauth_client": []}}}],
            "configuration_version": "1"
          }
          EOF

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run instrumentation tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          profile: Nexus 6
          script: ./gradlew connectedDebugAndroidTest

      - name: Upload instrumentation test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: instrumentation-test-results
          path: app/build/reports/androidTests/
          retention-days: 7

  # ============================================================================
  # FIREBASE APP DISTRIBUTION (Beta)
  # ============================================================================
  distribute-beta:
    name: Distribute to Firebase
    runs-on: ubuntu-latest
    needs: build-release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release APK
        uses: actions/download-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/

      - name: Debug - List downloaded files
        run: |
          echo "=== Files in release directory ==="
          ls -la app/build/outputs/apk/release/ || echo "Directory not found"
          echo ""
          echo "=== All APK files ==="
          find app/build/outputs -name "*.apk" -type f 2>/dev/null || echo "No APK files found"

      - name: Debug - Validate Firebase configuration
        env:
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "=== Firebase Configuration Check ==="

          # Check FIREBASE_APP_ID
          if [ -z "$FIREBASE_APP_ID" ]; then
            echo "❌ FIREBASE_APP_ID secret is not set!"
          else
            echo "✓ FIREBASE_APP_ID is set (length: ${#FIREBASE_APP_ID} chars)"
            # Show format without revealing full ID
            echo "  Format check: $(echo "$FIREBASE_APP_ID" | grep -E '^1:[0-9]+:android:[a-f0-9]+$' && echo 'Valid format' || echo 'Invalid format - expected 1:NUMBER:android:HEX')"
          fi

          # Check FIREBASE_SERVICE_ACCOUNT_JSON
          if [ -z "$FIREBASE_SERVICE_ACCOUNT_JSON" ]; then
            echo "❌ FIREBASE_SERVICE_ACCOUNT_JSON secret is not set!"
          else
            echo "✓ FIREBASE_SERVICE_ACCOUNT_JSON is set (length: ${#FIREBASE_SERVICE_ACCOUNT_JSON} chars)"
            # Validate JSON structure
            if echo "$FIREBASE_SERVICE_ACCOUNT_JSON" | python3 -c "import sys,json; json.load(sys.stdin)" 2>/dev/null; then
              echo "✓ Valid JSON format"
              # Check for required fields
              echo "$FIREBASE_SERVICE_ACCOUNT_JSON" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          required = ['type', 'project_id', 'private_key', 'client_email']
          for field in required:
              if field in data:
                  if field == 'project_id':
                      print(f'  ✓ {field}: {data[field]}')
                  elif field == 'client_email':
                      print(f'  ✓ {field}: {data[field]}')
                  else:
                      print(f'  ✓ {field}: [present]')
              else:
                  print(f'  ❌ {field}: MISSING')
          "
            else
              echo "❌ Invalid JSON format"
            fi
          fi

      - name: Find and set APK path
        id: find-apk
        run: |
          echo "=== Finding APK file ==="

          # Look for any release APK
          APK_FILE=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -1)

          if [ -z "$APK_FILE" ]; then
            echo "❌ No APK file found in release directory!"
            exit 1
          fi

          echo "✓ Found APK: $APK_FILE"
          echo "  Size: $(ls -lh "$APK_FILE" | awk '{print $5}')"
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT

      - name: Check tester group configuration
        id: check-group
        run: |
          echo "=== Tester Group Configuration ==="
          echo "Note: If 'internal-testers' group doesn't exist in Firebase App Distribution,"
          echo "      create it at: Firebase Console → App Distribution → Testers & Groups"
          echo ""
          echo "Configured group: internal-testers"
          echo "If distribution fails with 404, the group may not exist."
          echo ""
          # Check if FIREBASE_TESTER_GROUPS secret exists as override
          if [ -n "${{ secrets.FIREBASE_TESTER_GROUPS }}" ]; then
            echo "groups=${{ secrets.FIREBASE_TESTER_GROUPS }}" >> $GITHUB_OUTPUT
            echo "Using custom tester groups from secret: ${{ secrets.FIREBASE_TESTER_GROUPS }}"
          else
            echo "groups=internal-testers" >> $GITHUB_OUTPUT
            echo "Using default tester group: internal-testers"
          fi

      - name: Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          groups: ${{ steps.check-group.outputs.groups }}
          file: ${{ steps.find-apk.outputs.apk_path }}
          releaseNotes: |
            Build: ${{ github.run_number }}
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}

            Changes in this build:
            - See commit history for details


